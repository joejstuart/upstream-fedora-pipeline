#!groovy


timestamps {
    def libraries = ['ci-pipeline'             : ['master', 'https://github.com/CentOS-PaaS-SIG/ci-pipeline.git'],
                     'upstream-fedora-pipeline': ['CONTRA-503', 'https://github.com/joejstuart/upstream-fedora-pipeline.git'],
                     'contra-lib'              : ['messaging', 'https://github.com/joejstuart/contra-lib.git']]

    libraries.each { name, repo ->
        library identifier: "${name}@${repo[0]}",
                retriever: modernSCM([$class: 'GitSCMSource',
                                      remote: repo[1]])

    }

    properties(
            [
                    buildDiscarder(logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '500', daysToKeepStr: '', numToKeepStr: '500')),
                    parameters(
                            [
                                    string(description: 'fedora-fedmsg', defaultValue: '{}', name: 'CI_MESSAGE')
                            ]
                    ),
                    pipelineTriggers(
                            []
                                   // [$class: 'CIBuildTrigger', checks: [[expectedValue: '1', field: 'new']], providerName: 'fedora-fedmsg', selector: 'topic = "org.fedoraproject.prod.buildsys.build.state.change"']]
                    )
            ]
    )

    node() {

        stageVars = pipelineData.stageVars(env.CI_MESSAGE)
        buildVars = pipelineData.buildVars(env.CI_MESSAGE)

        ciPipeline(buildPrefix: 'Fedora_All_Packages_Pipeline', buildVars: buildVars) {
            stepName = 'upstream-fedora-pipeline-build-trigger'
            stage(stepName) {

                skippedMsg = pipelineData.setMessageFields('package.ignored', 'build', env.CI_MESSAGE)
                queuedMsg = pipelineData.setMessageFields('package.queued', 'build', env.CI_MESSAGE)

                validMessage = buildTrigger(skippedMsg: skippedMsg, queuedMsg: queuedMsg) {
                    pipelineData.upstreamTrigger(env.CI_MESSAGE)

                }

            }

            if (validMessage) {
                stepName = 'schedule build'
                params = [
                        PROVIDED_KOJI_TASKID: stageVars[stepName]['PROVIDED_KOJI_TASKID'],
                        CI_MESSAGE: env.CI_MESSAGE
                ]

                stage(stepName) {
                    branch = stageVars[stepName]['branch']
                    scheduleBuild(buildName: "fedora-${branch}-build-pipeline", params: params)
                }

            }
        }

    }
}
