#!groovy

timestamps {
    // canned CI_MESSAGE
    // Might just keep this for legacy reasons for now
    def CANNED_CI_MESSAGE = '{"commit":{"username":"zdohnal","stats":{"files":{"README.patches":{"deletions":0,"additions":30,"lines":30},"sources":{"deletions":1,"additions":1,"lines":2},"vim.spec":{"deletions":7,"additions":19,"lines":26},".gitignore":{"deletions":0,"additions":1,"lines":1},"vim-8.0-rhbz1365258.patch":{"deletions":0,"additions":12,"lines":12}},"total":{"deletions":8,"files":5,"additions":63,"lines":71}},"name":"Zdenek Dohnal","rev":"3ff427e02625f810a2cedb754342be44d6161b39","namespace":"rpms","agent":"zdohnal","summary":"Merge branch f25 into f26","repo":"vim","branch":"f26","seen":false,"path":"/srv/git/repositories/rpms/vim.git","message":"Merge branch \'f25\' into f26\n","email":"zdohnal@redhat.com"},"topic":"org.fedoraproject.prod.git.receive"}'

    def libraries = ['cico-pipeline'           : ['master', 'https://github.com/CentOS/cico-pipeline-library.git'],
                     'ci-pipeline'             : ['master', 'https://github.com/CentOS-PaaS-SIG/ci-pipeline.git'],
                     'contralib'               : ['messaging', 'https://github.com/joejstuart/contra-lib.git'],
                     'fedora-upstream-pipeline': ['CONTRA-503', 'https://github.com/joejstuart/upstream-fedora-pipeline.git']]

    libraries.each { name, repo ->
        library identifier: "${name}@${repo[0]}",
                retriever: modernSCM([$class: 'GitSCMSource',
                                      remote: repo[1]])

    }

    //noinspection GroovyAssignabilityCheck
    properties(
            [
                    buildDiscarder(logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '100', daysToKeepStr: '', numToKeepStr: '100')),
                    disableConcurrentBuilds(),
                    // Will need to add pagure.pull-request.comment.added and
                    // whatever it is for commits added soon most likely
                    pipelineTriggers(
                            [[$class: 'CIBuildTrigger', checks: [[expectedValue: 'rpms', field: '$.pullrequest.project.namespace']], providerName: 'fedora-fedmsg', selector: 'topic = "org.fedoraproject.prod.pagure.pull-request.new" OR topic = "org.fedoraproject.prod.pagure.pull-request.comment.added"'
                             ]]
                    ),

                    parameters(
                            [
                                    string(defaultValue: CANNED_CI_MESSAGE, description: 'CI_MESSAGE', name: 'CI_MESSAGE')
                            ]
                    )
            ]
    )

    node() {

        stageVars = pipelineData.prStageVars(env.CI_MESSAGE)

        ciPipeline(buildPrefix: 'Fedora_All_Packages_Pipeline', package_name: stageVars['default']['package_name']) {
            stepName = 'upstream-fedora-pipeline-build-trigger'
            stage(stepName) {

                skippedMsg = pipelineData.setMessageFields('package.ignored', 'build', env.CI_MESSAGE)
                queuedMsg = pipelineData.setMessageFields('package.queued', 'build', env.CI_MESSAGE)

                validMessage = buildTrigger(skippedMsg: skippedMsg, queuedMsg: queuedMsg) {
                    pipelineData.prTrigger(stageVars)

                }

            }

            if (validMessage) {
                stepName = 'schedule build'
                params = [
                        CI_MESSAGE: env.CI_MESSAGE
                ]

                stage(stepName) {
                    branch = stageVars['branch']
                    scheduleBuild(buildName: "fedora-joe-build-pipeline", params: params)
                }

            }
        }

    }
}