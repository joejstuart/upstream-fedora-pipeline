#!groovy

timestamps {
    // canned CI_MESSAGE
    // Might just keep this for legacy reasons for now
    def CANNED_CI_MESSAGE = '{"pullrequest":{"status":"Open","last_updated":"1528294938","branch_from":"feature/update-1.0.3","uid":"a60335ffa4954da29dc6b7b76ac8cb02","commit_stop":"4289f34160c84de5ae488b68affae0918a4c5b1d","initial_comment":"Updated to latest version 1.0.3.\\r\\n\\r\\n- Fixed build failure.\\r\\n- Fixed test failure.\\r\\n- Relaxed the dependency of sass to use sass 3.5. Sass is going to be updated to 3.5 soon.\\r\\n- Scratch build: https://koji.fedoraproject.org/koji/taskinfo?taskID=27438205\\r\\n\\r\\nAfter your review, I can update `sources` and `.gitignore` files, running `fedpkg import`.","title":"Updated to 1.0.3","comments":[{"comment":"Could you please use %gemspec_{remove,add}_dep macros instead? And use them for the rb-fsevent above as well (it would be probably better to have separate commit for it).","parent":null,"notification":false,"tree":"8cfcb5b04fea32bd58a19eadb868324c86221c42","filename":"rubygem-compass.spec","edited_on":null,"editor":null,"date_created":"1528282281","commit":"b024a5a34eca83632e246057a7a4360dfbad8433","line":23,"id":11025,"user":{"fullname":"Vít Ondruch","name":"vondruch"}},{"comment":"Since you update the package, it would be probably good to expand the .gem using %setup macro.","parent":null,"notification":false,"tree":null,"filename":null,"edited_on":null,"editor":null,"date_created":"1528282328","commit":null,"line":null,"id":11026,"user":{"fullname":"Vít Ondruch","name":"vondruch"}},{"comment":"rebased onto 4289f34160c84de5ae488b68affae0918a4c5b1d","parent":null,"notification":true,"tree":null,"filename":null,"edited_on":null,"editor":null,"date_created":"1528294756","commit":null,"line":null,"id":11047,"user":{"fullname":"Jun Aruga","name":"jaruga"}},{"comment":"@vondruch rebased. To use the macro without -s gemspec_file, I modified additional lines aligning the result of latest gem2rpm.\\r\\n\\r\\nJust in case, I checked the dependency is set correctly by below command for created binary RPM.\\r\\n\\r\\n```\\r\\n$ rpm -qR rubygem-compass-1.0.3-1.fc29.noarch.rpm\\r\\n(rubygem(chunky_png) >= 1.2 with rubygem(chunky_png) < 2)\\r\\n(rubygem(compass-core) >= 1.0.2 with rubygem(compass-core) < 1.1)\\r\\n(rubygem(compass-import-once) >= 1.0.5 with rubygem(compass-import-once) < 1.1)\\r\\n(rubygem(sass) < 3.6 with rubygem(sass) >= 3.3.13)\\r\\n/usr/bin/ruby\\r\\nrpmlib(CompressedFileNames) <= 3.0.4-1\\r\\nrpmlib(FileDigests) <= 4.6.0-1\\r\\nrpmlib(PayloadFilesHavePrefix) <= 4.0-1\\r\\nrpmlib(PayloadIsXz) <= 5.2-1\\r\\nrpmlib(RichDependencies) <= 4.12.0-1\\r\\nruby(rubygems)\\r\\nrubygem(rb-inotify) >= 0.9\\r\\n```\\r\\n","parent":null,"notification":false,"tree":null,"filename":null,"edited_on":null,"editor":null,"date_created":"1528294938","commit":null,"line":null,"id":11048,"user":{"fullname":"Jun Aruga","name":"jaruga"}}],"id":1,"project":{"custom_keys":[],"description":"The rubygem-compass rpms","parent":null,"date_modified":"1507641927","access_users":{"admin":["tdawson"],"commit":[],"ticket":[],"owner":["mmorsi"]},"namespace":"rpms","url_path":"rpms/rubygem-compass","priorities":{},"id":20312,"access_groups":{"admin":[],"commit":[],"ticket":[]},"milestones":{},"user":{"fullname":"Mo Morsi","name":"mmorsi"},"date_created":"1501874511","fullname":"rpms/rubygem-compass","settings":{"issues_default_to_private":false,"Minimum_score_to_merge_pull-request":-1,"pull_request_access_only":false,"stomp_notifications":true,"Web-hooks":null,"fedmsg_notifications":true,"always_merge":false,"project_documentation":false,"Enforce_signed-off_commits_in_pull-request":false,"notify_on_commit_flag":false,"notify_on_pull-request_flag":false,"roadmap_on_issues_page":false,"pull_requests":true,"Only_assignee_can_merge_pull-request":false,"issue_tracker":true},"close_status":[],"tags":[],"name":"rubygem-compass"},"assignee":null,"repo_from":{"custom_keys":[],"description":"The rubygem-compass rpms","parent":{"custom_keys":[],"description":"The rubygem-compass rpms","parent":null,"date_modified":"1507641927","access_users":{"admin":["tdawson"],"commit":[],"ticket":[],"owner":["mmorsi"]},"namespace":"rpms","url_path":"rpms/rubygem-compass","priorities":{},"id":20312,"access_groups":{"admin":[],"commit":[],"ticket":[]},"milestones":{},"user":{"fullname":"Mo Morsi","name":"mmorsi"},"date_created":"1501874511","fullname":"rpms/rubygem-compass","settings":{"issues_default_to_private":false,"Minimum_score_to_merge_pull-request":-1,"pull_request_access_only":false,"stomp_notifications":true,"Web-hooks":null,"fedmsg_notifications":true,"always_merge":false,"project_documentation":false,"Enforce_signed-off_commits_in_pull-request":false,"notify_on_commit_flag":false,"notify_on_pull-request_flag":false,"roadmap_on_issues_page":false,"pull_requests":true,"Only_assignee_can_merge_pull-request":false,"issue_tracker":true},"close_status":[],"tags":[],"name":"rubygem-compass"},"date_modified":"1528126887","access_users":{"admin":[],"commit":[],"ticket":[],"owner":["jaruga"]},"namespace":"rpms","url_path":"fork/jaruga/rpms/rubygem-compass","priorities":{},"id":30924,"access_groups":{"admin":[],"commit":[],"ticket":[]},"milestones":{},"user":{"fullname":"Jun Aruga","name":"jaruga"},"date_created":"1528126887","fullname":"forks/jaruga/rpms/rubygem-compass","settings":{"issues_default_to_private":false,"Minimum_score_to_merge_pull-request":-1,"pull_request_access_only":false,"stomp_notifications":true,"Web-hooks":null,"fedmsg_notifications":true,"always_merge":false,"project_documentation":false,"Enforce_signed-off_commits_in_pull-request":false,"notify_on_commit_flag":false,"notify_on_pull-request_flag":false,"roadmap_on_issues_page":false,"pull_requests":false,"Only_assignee_can_merge_pull-request":false,"issue_tracker":false},"close_status":[],"tags":[],"name":"rubygem-compass"},"cached_merge_status":"FFORWARD","updated_on":"1528210554","commit_start":"4289f34160c84de5ae488b68affae0918a4c5b1d","branch":"master","date_created":"1528210554","closed_at":null,"remote_git":null,"closed_by":null,"user":{"fullname":"Jun Aruga","name":"jaruga"}},"agent":"jaruga","topic":"org.fedoraproject.prod.pagure.pull-request.comment.added"}'

    def libraries = ['cico-pipeline'           : ['master', 'https://github.com/CentOS/cico-pipeline-library.git'],
                     'ci-pipeline'             : ['master', 'https://github.com/CentOS-PaaS-SIG/ci-pipeline.git'],
                     'contralib'               : ['messaging', 'https://github.com/joejstuart/contra-lib.git'],
                     'fedora-upstream-pipeline': ['CONTRA-503', 'https://github.com/joejstuart/upstream-fedora-pipeline.git']]

    libraries.each { name, repo ->
        library identifier: "${name}@${repo[0]}",
                retriever: modernSCM([$class: 'GitSCMSource',
                                      remote: repo[1]])

    }

    //noinspection GroovyAssignabilityCheck
    properties(
            [
                    buildDiscarder(logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '100', daysToKeepStr: '', numToKeepStr: '100')),
                    disableConcurrentBuilds(),
                    // Will need to add pagure.pull-request.comment.added and
                    // whatever it is for commits added soon most likely
                    pipelineTriggers(
                          //  [[$class: 'CIBuildTrigger', checks: [[expectedValue: 'rpms', field: '$.pullrequest.project.namespace']], providerName: 'fedora-fedmsg', selector: 'topic = "org.fedoraproject.prod.pagure.pull-request.new" OR topic = "org.fedoraproject.prod.pagure.pull-request.comment.added"'
                          //   ]]
                    ),

                    parameters(
                            [
                                    string(defaultValue: CANNED_CI_MESSAGE, description: 'CI_MESSAGE', name: 'CI_MESSAGE')
                            ]
                    )
            ]
    )

    node() {

        stageVars = pipelineData.prStageVars(env.CI_MESSAGE)

        ciPipeline(buildPrefix: 'Fedora_All_Packages_Pipeline', package_name: stageVars['package_name']) {
            prepareEnvironment(stageVars: stageVars)

            stepName = 'upstream-fedora-pipeline-build-trigger'
            stage(stepName) {

                skippedMsg = pipelineData.setMessageFields('package.ignored', 'build', env.CI_MESSAGE)
                queuedMsg = pipelineData.setMessageFields('package.queued', 'build', env.CI_MESSAGE)

                validMessage = buildTrigger(skippedMsg: skippedMsg, queuedMsg: queuedMsg) {
                    pipelineData.prTrigger(stageVars)

                }

            }

            if (validMessage) {
                stepName = 'schedule build'
                params = [
                        CI_MESSAGE: env.CI_MESSAGE
                ]

                stage(stepName) {
                    branch = stageVars['branch']
                    scheduleBuild(buildName: "fedora-joe-build-pipeline", params: params)
                }

            }
        }

    }
}
